# Multi-Trisonica GUI

TriSonica超音波風速計用のマルチセンサーデータ取得GUIアプリケーション

## 概要

最大4台のTriSonica超音波風速計を同時に接続し、リアルタイムでデータを取得・可視化・記録するためのPyQt5ベースのデスクトップアプリケーションです。

### 主な機能

- **マルチセンサー対応**: 最大4台のセンサーを同時接続・測定
- **JSONプロトコル対応**: TriSonica FW 3.0.0以降のJSONプロトコルに対応
- **長時間測定**: 200,000サンプルの循環バッファ（25Hzで約2.2時間）
- **リアルタイム可視化**: 単一センサー表示とマルチセンサー比較表示
- **CSV記録**: 測定データの自動CSV出力
- **設定の自動保存**: COM設定、ウィンドウ位置などを自動保存

## システム要件

### 必須環境
- Windows 10/11
- Python 3.12以上
- シリアルポート（USB-Serial変換アダプタ対応）

### 対応センサー
- TriSonica Mini/Standard/Pro (FW 3.0.0以降推奨)
- JSONプロトコル対応モデル

## インストール

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd MultiTrisonica
```

### 2. 自動セットアップ（推奨）

```bash
launch.bat
```

`launch.bat`が自動的に以下を実行します：
- Python 3.12の検出
- 仮想環境の作成
- 依存パッケージのインストール
- アプリケーションの起動

### 3. 手動セットアップ

```bash
# 仮想環境の作成
python -m venv .venv

# 仮想環境の有効化
.venv\Scripts\activate

# 依存パッケージのインストール
pip install -r requirements.txt

# アプリケーションの起動
python src/main.py
```

## 使い方

### 基本的な使い方

1. **アプリケーション起動**: `launch.bat`をダブルクリック

2. **センサー接続**:
   - Connectionタブで各センサーのCOMポートとボーレートを選択
   - 「Connect」ボタンをクリック
   - センサー情報が自動的に表示されます

3. **データ表示**:
   - **Single Sensorタブ**: 1台のセンサーのデータを詳細表示
   - **Multi Sensorタブ**: 複数センサーのデータを比較表示

4. **データ記録**:
   - 「Start Recording」ボタンでCSV記録開始
   - `data/`フォルダに自動保存

### センサー情報表示

接続後、各センサーパネルに以下の情報が表示されます：

- **Protocol**: 通信プロトコル（JSON/ASCII）
- **Model**: センサーモデル（例: TSM3D）
- **S/N**: シリアル番号
- **Firmware**: ファームウェアバージョン
- **Sample Rate**: サンプリングレート（Hz）
- **Enabled Tags**: 有効な出力タグ

### 出力レート変更

JSONプロトコル対応センサーでは、リアルタイムで出力レートを変更できます：

1. Connectionタブの「Output Rate Configuration」で値を変更（1-10Hz）
2. 接続中のすべてのJSONセンサーに自動的に反映

## 機能詳細

### 1. DVタグ対応

TriSonicaの垂直風向（DV: Vertical Direction）タグに対応：

```
S  03.95 D  267 DV  045 U  02.81 V  0.15 W  2.78 T  31.50 PI  43.4 RO  46.3
```

- **DV**: 垂直方向の風向（degrees）
- パーサーが自動認識し、警告なしで処理

### 2. 動的タグ検出

センサーの設定から有効なタグを自動検出：

- センサー接続時に`{settings}`コマンドで設定を取得
- Outputセクションから有効タグを抽出
- センサー情報パネルに表示

**対応タグ**:
- S: 2D風速
- D: 水平風向
- DV: 垂直風向
- U, V, W: 風速成分
- T: 音波温度
- PI, RO: ピッチ・ロール角

### 3. 大容量バッファ

長時間測定に対応した循環バッファ：

- **容量**: 200,000サンプル/センサー
- **測定時間**: 25Hzで約2.2時間
- **メモリ使用量**: 
  - 1センサー: 約64 MB
  - 2センサー: 約128 MB
  - 4センサー: 約256 MB

### 4. 設定の自動保存

以下の設定が自動的に保存されます：

- **センサー設定**: COMポート、ボーレート、初期化コマンド
- **ウィンドウ設定**: 位置、サイズ
- **出力レート**: 最後に設定した値

設定ファイル: `config.json`

## プロジェクト構造

```
MultiTrisonica/
├── src/
│   ├── main.py                 # アプリケーションエントリーポイント
│   ├── controllers/
│   │   ├── app_controller.py   # アプリケーション全体の制御
│   │   └── sensor_controller.py # 個別センサー制御
│   ├── models/
│   │   ├── sensor_data.py      # データモデル
│   │   └── app_config.py       # 設定モデル
│   ├── views/
│   │   ├── main_window.py      # メインウィンドウ
│   │   ├── connection_tab.py   # 接続タブ
│   │   ├── single_sensor_tab.py # 単一センサー表示
│   │   └── multi_sensor_tab.py  # マルチセンサー表示
│   ├── workers/
│   │   └── sensor_worker.py    # センサー通信スレッド
│   └── utils/
│       ├── serial_parser.py    # データパーサー
│       ├── csv_writer.py       # CSV出力
│       ├── logger.py           # ログシステム
│       └── validators.py       # 入力検証
├── tests/                      # ユニットテスト
├── logs/                       # ログファイル（自動生成）
├── data/                       # 測定データ（自動生成）
├── config.json                 # 設定ファイル（自動生成）
├── requirements.txt            # Python依存パッケージ
├── launch.bat                  # 起動スクリプト
└── README.md                   # このファイル
```

## 開発情報

### 使用技術

- **GUI**: PyQt5 5.15.11
- **シリアル通信**: PySerial 3.5
- **データ可視化**: Matplotlib 3.9.3
- **アーキテクチャ**: MVC + Worker Thread

### ログ

アプリケーションログは`logs/`ディレクトリに保存されます：

- `app_YYYYMMDD_HHMMSS.log`: アプリケーションログ
- 最大10ファイル、各10MBまで自動ローテーション

### テスト実行

```bash
# すべてのテストを実行
python -m pytest tests/

# カバレッジレポート付き
python -m pytest tests/ --cov=src --cov-report=html
```

## トラブルシューティング

### センサーが接続できない

1. **COMポート確認**: デバイスマネージャーでポート番号を確認
2. **ボーレート確認**: センサーのボーレート設定（通常115200）
3. **ドライバー確認**: USB-Serialドライバーがインストールされているか
4. **他のアプリ確認**: 他のアプリケーションでポートが使用されていないか

### データが表示されない

1. **センサー情報確認**: 接続後、センサー情報パネルが表示されるか
2. **ログ確認**: `logs/`ディレクトリのログファイルをチェック
3. **出力設定確認**: センサーの出力設定が有効になっているか

### メモリ不足

長時間測定でメモリ使用量が増加する場合：

1. **バッファサイズ調整**: `src/controllers/sensor_controller.py`の`maxlen`を調整
2. **センサー数削減**: 使用するセンサー数を減らす
3. **定期的な再起動**: 長時間測定の場合は定期的にアプリを再起動

## 実装履歴

### v1.2.0 (2025-12-25)
- ✅ バッファサイズを200,000サンプルに拡大（20倍）
- ✅ 2センサー同時センシング動作確認

### v1.1.0 (2025-12-25)
- ✅ DVタグ（垂直風向）対応
- ✅ センサー情報表示パネル実装
- ✅ 動的出力レート変更機能
- ✅ 動的タグ検出機能
- ✅ 設定の自動保存・復元機能
- ✅ バッファサイズ10,000サンプルに拡大
- ✅ 実機テスト完了（TriSonica TSM3D, FW 3.0.0）

### v1.0.0 (初期リリース)
- 基本的なマルチセンサー接続機能
- リアルタイム表示
- CSV記録機能

## ライセンス

このプロジェクトは内部使用のために開発されています。

## 連絡先

問題や質問がある場合は、プロジェクト管理者にお問い合わせください。

---

**開発**: Multi-Trisonica GUI Development Team  
**最終更新**: 2025-12-25
